## CVE-2018-3778

### Introduction
MQTT is a publish-subscribe network protocol that transports messages between devices.
Aedes is an open source library for a MQTT server implementation written in JavaScript.

### The Vulnerability
Aedes does not respect its own authorization rules for LWT (Last Will and Testament) message.

"In MQTT, you use the Last Will and Testament (LWT) feature to notify other clients about an ungracefully disconnected client." (C)

The issue resides in the internal client implementation of the Aedes MQTT server specifically at the `lib/client.js` file in the `finish` method.

```js
function finish () {
    if (!that.disconnected && that.will) {
        that.broker.publish(that.will, that, function (err) {
            // ...
        });
    }
    //...
}
```

As you can see above when the client is disconnected and has a will (The LWT message) it would invoke the publish method without an authorization check.

### The Fix
This issue was fixed by adding the authorization check before invoking the publish method (B). and it's no longer exploitable.

### Proof of concept
I couldn't find a public proof of concept for this bug, so I wrote one myself.

Usage:
```
npm run server
npm run client
```

Expected server output:
```
client connected!
Reject all packet!
got message-> will!
client disconnected!
```

### Refrences

A. https://github.com/moscajs/aedes/issues/211

B. https://github.com/moscajs/aedes/pull/212/files

C. https://www.hivemq.com/blog/mqtt-essentials-part-9-last-will-and-testament/