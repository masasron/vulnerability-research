## CVE-2018-1002204

### Introduction
ZIP archive unpacking with path traversal / symlinks is part of the ZIP specification.
Due to low security awareness of developers, this functionality could be abused to overwrite files leading in some cases to an RCE (C).

CVE-2018-1002204 is also known as Zip Slip, which is basically a Snyk marketing campaign - rediscovering a 20 years old "bug".

This issue affects a lot of libraries, I focused on "archiver" written in go.

### The Vulnerability
A vulnerable application would be any app that extract untrusted zip file using a valid ZIP implementation. This is due to the fact path traversal and symlink can be abused by an attacker to overwrite arbitrary files on the file system.

In "archiver" the vulnerable files were `rar.go`, `tar.go` and `zip.go` see (D)

They all did broadly the same thing, concatenating each file path from the ZIP/TAR/RAR file using `filepath.Join` without checking for path traversal, as the specification states.

### The Fix

At the time of the vulnerability report the library authors wrote:
"to avoid zip slip (writing outside of the destination), we resolve the target path, and make sure it's nested in the intended destination, or bail otherwise."

```go
func sanitizeExtractPath(filePath string, destination string) error {
	destpath := filepath.Join(destination, filePath)
	if !strings.HasPrefix(destpath, destination) {
		return fmt.Errorf("%s: illegal file path", filePath)
	}
	return nil
}
```

As you can see above the `sanitizeExtractPath` method is supposed to insure writing outside of the destination folder is impossible, however, it can easily be bypassed by including the destination folder at the start of our traversal, or if the app unarchives the zip to a relative destination, for example `./`

Currently, the unarchive method is still vulnerable to path traversal and symlink attacks.
However, the library does provid verios other APIs to securely extract files from untrusted archives.
For example, the extract method can be used securely extract a single file from an untrusted archive into a desirable destination.
The extract method uses the `within` method below to prevent path traversal:

```go
func within(parent, sub string) bool {
	rel, err := filepath.Rel(parent, sub)
	if err != nil {
		return false
	}
	return !strings.Contains(rel, "..")
}
```

`filepath.Rel` returns a relative path that is lexically equivalent to targpath when joined to basepath with an intervening separator. (E)
Additionally, we insure the relative path returned to us does not contains `..`.

### Proof of concept

```
cd ./PoC
./zipslip_symlink.sh
Run ./vulnerable_archiver unarchive /tmp/zip/test.tar ./
./vulnerable_archiver unarchive /tmp/zip/test.tar ./
cat /tmp/zipslip
hi

./zipslip_pt.sh
adding: ../../../../../../../../../../../../../../../../../../../../../../../../tmp/zipslip (stored 0%)
Run ./vulnerable_archiver unarchive /tmp/zip/test.zip ./
cat /tmp/zipslip
pt
```

### Refrences
A. https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT

B. https://snyk.io/research/zip-slip-vulnerability

C. https://www.youtube.com/watch?v=l1MT5lr4p9o

D. https://github.com/mholt/archiver/pull/65/files

E. https://golang.org/pkg/path/filepath/#Rel